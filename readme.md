# Display_Log 2.0 - 机器人定位日志分析工具集

## 📑 项目简介

本项目是一套专为机器人定位系统设计的日志分析和可视化工具集。基于 Python 开发，完美兼容 Windows 环境。项目包含多个独立的功能模块，旨在帮助研发和测试人员高效分析、可视化以及验证机器人定位系统的性能指标。

## 📂 目录结构

```text
f:\display_log2.0\
├── Display_location\          # 定位轨迹可视化工具 (二维轨迹、播放回放)
├── FrameByFrameReplay\        # 点云逐帧回放工具 (3D点云、激光雷达)
├── LinearOscillation\         # 轨迹拟合与线性度分析工具 (PCA直线拟合、横向误差)
├── ShowLidarRangingError\     # 激光雷达测距误差分析工具 (距离偏差统计)
├── StaticPose\                # 静态位姿分析工具 (静止状态漂移与波动)
├── TrajectoryComparison\      # 轨迹评估对比工具 (Evo-like APE/RPE分析)
└── readme.md                  # 本文档

```

---

## 🛠️ 环境配置规范（首次运行必看）

### 1. 硬件与系统要求

* **操作系统**: Windows 10 / Windows 11 (64位)
* **Python 版本**: 推荐 Python 3.9 - 3.11（`tool` 文件夹已提供 3.11.6 安装包）
* **硬件配置**: 建议 4 核 CPU + 8GB 内存以上，需配备支持 OpenGL 的独立显卡（用于 3D 点云渲染）。

### 2. Python 环境安装与命令说明

> **💡 【重要必读】关于 `python` 与 `py` 命令的区别**
> 在 Windows 下打开命令行（`Win + R` 输入 `cmd`），由于安装习惯不同，调用 Python 的命令可能不同：
> * `python`：标准命令。但前提是安装时**必须**勾选了 "Add Python to PATH"。如果没勾选，系统会报错或弹出微软应用商店。
> * `py`：Windows 专用的 Python 启动器魔法命令。即便你忘了配环境变量，只要正常安装了 Python，敲 `py` 也能 100% 成功唤醒 Python。
> 
> 
> **本教程后续统一推荐使用 `py` 前缀以避免由于环境变量带来的麻烦。**

#### 2.1 安装 Python

1. 进入 `tool` 文件夹，双击运行 `python-3.11.6-amd64.exe`。
2. **【极其关键】**：在安装界面底部，**务必勾选 "Add python.exe to PATH"**。
3. 点击 "Install Now" 完成安装。

#### 2.2 验证安装

按下 `Win + R` 键，输入 `cmd` 并回车，输入以下命令验证：

```bash
py --version
py -m pip --version

```

*(如果正常输出版本号如 `Python 3.11.6` 和 `pip 23.x.x`，说明安装完美成功！)*

#### 2.3 创建与激活虚拟环境（强烈推荐）

为了不污染你电脑上的全局环境，建议为本项目单独创建一个虚拟环境。在刚才的 `cmd` 窗口中依次执行：

```bash
# 1. 进入项目根目录 (请根据你的实际存放路径修改)
cd /d F:\display_log2.0

# 2. 创建名为 venv 的虚拟环境
py -m venv venv

# 3. 激活虚拟环境 (激活成功后，命令行前面会多出一个 (venv) 标识)
.\venv\Scripts\activate

```

### 3. 安装依赖库

在**确保虚拟环境已激活**（命令行带有 `(venv)` 前缀）的情况下，执行以下命令一键安装所有需要的依赖。
*(注：已默认添加清华镜像源，解决国内下载缓慢或超时报错的问题)*

```bash
py -m pip install PyQt5 pyqtgraph open3d numpy matplotlib -i https://pypi.tuna.tsinghua.edu.cn/simple

```

**验证依赖是否安装成功：**

```bash
py -c "import PyQt5, pyqtgraph, open3d, numpy, matplotlib; print('✅ 所有依赖安装成功！')"

```

---

## 🚀 各模块使用指南

### 1. Display_location - 定位轨迹可视化工具

**功能描述**: 二维可视化机器人定位轨迹，支持多轨迹对比、点击跳转、时间段筛选，并能叠加显示 Landmark（如反光板、二维码）。

#### 数据准备
- 将日志文件（`.log` 或 `.txt`）放入 `Display_location/logs/` 目录
- 将地图文件（`.pcd` 格式）放入 `Display_location/map/` 目录

#### 日志格式要求
```
时间戳: 2024-01-15 10:30:45,123
Location_state = RealTimeLocation:10 type = 20 (x y z roll pitch yaw)
```

#### 启动命令
```bash
cd Display_location
py main.py
```

#### 操作说明

**界面布局**:
- 左侧为控制面板，右侧为轨迹显示区
- 支持多轨迹同时显示对比

**主要功能**:

1. **轨迹点击跳转**
   - 在右侧图表中点击任意轨迹点
   - 左侧数据面板自动跳转并显示对应帧信息
   - 自动切换到对应的日志文件

2. **播放控制**
   - 使用滑块快速定位到任意帧
   - `<<` / `>>` 按钮逐帧前进/后退
   - 显示当前帧的时间戳、状态、类型、坐标信息

3. **时间范围筛选**
   - 通过下拉框选择起始时间和结束时间
   - 自动截取并显示指定时间段的轨迹
   - 显示筛选后的帧数统计

4. **Landmark 显示**
   - 自动识别并显示 QRCode（二维码）
   - 自动识别并显示 Reflector（反光板）
   - 不同类型使用不同颜色和符号标识

5. **地图自动识别**
   - 全局地图：白色，点密度细密
   - 反光板地图：红色，点大小醒目
   - 局部地图：使用循环颜色区分

#### 键盘快捷键
- `←` : 上一帧
- `→` : 下一帧

#### 数据导出
- 点击"Export Frame"按钮导出当前帧信息
- 导出文件保存在 `out/` 目录
- 文件命名格式：`exp_{日志名}_{帧索引}.txt`

#### 注意事项
- 日志文件必须包含 `Location_state` 字段
- 支持显示定位状态（如 RealTimeLocation、GlobalLocation 等）
- 状态以绿色显示表示正常，红色表示异常



### 2. FrameByFrameReplay - 点云逐帧回放工具

**功能描述**: 3D 逐帧播放激光雷达点云，高亮显示高强度点（如反光柱），并实时展示机器人的坐标原点与朝向。

#### 数据准备
- 将连续帧的点云文件（`.pcd` 格式）放入 `FrameByFrameReplay/scans_directory/` 目录
- 将全局地图文件命名为 `global_map.pcd` 放入 `FrameByFrameReplay/map/` 目录

#### 点云文件命名
- 建议按时间戳命名，如：`312000819_20.pcd`
- 文件会自动按名称排序播放

#### 启动命令
```bash
cd FrameByFrameReplay
py pcd_viewer.py
```

#### 操作快捷键
- `右箭头 (→)`: 下一帧
- `左箭头 (←)`: 上一帧
- `R 键`: 视角回正（XY平面俯视）
- `鼠标操作`: 支持旋转、缩放、平移视图
- `Q 键`: 退出程序

#### 显示说明
- **蓝色点**：普通激光雷达点云
- **红色点**：高强度点（intensity > 250）
- **蓝色箭头**：机器人朝向（显示在最高层）
- **灰色背景**：全局地图

#### 控制台输出
- 实时显示当前帧序号和文件名
- 显示坐标原点位置
- 显示帧总数统计

#### 注意事项
- 确保所有点云文件的点数一致（坐标对应）
- 点云文件应包含 `.pcd` 格式的 VIEWPOINT 字段
- 推荐分辨率：1280x720 或以上
- 内存不足时考虑降低点云分辨率



### 3. LinearOscillation - 轨迹拟合与线性度分析工具

**功能描述**: 基于 PCA 算法对机器人的直线运动进行完美直线拟合，计算小车偏离直线的**横向位置误差 (距离)** 以及 **朝向角波动 (RZ)**。

#### 启动命令
```bash
cd LinearOscillation
py main.py
```

#### 使用流程
1. 点击【选择文件夹】按钮，选择包含日志文件的目录
2. 程序会自动递归搜索子目录中的所有日志文件（.log、.txt）
3. 在左侧下拉框选择分析的起始时间和结束时间
4. 选择定位类型（type，如 20、50、70 等）
5. 点击【拟合分析与绘图】按钮

#### 图表操作
- 支持鼠标拖拽平移
- 支持滚轮缩放
- 使用 matplotlib 工具栏保存图片

#### 分析结果解读

**位置误差分析**:
- **最大值/最小值**: 误差的极端值
- **平均值**: 平均绝对误差 (MAE)
- **绝对平均误差 (MAE)**: 车体质心偏离理想直线的平均垂直距离
- **标准差 (波动)**: 误差的离散程度，越小越稳定

**朝向误差分析**:
- **平均偏差**: 车体实际偏航角与拟合直线走向的平均夹角
- **标准差**: 朝向角度的波动程度

#### 日志格式要求
```
2024-01-15 10:30:45,123 ... type = 20 (x y z roll pitch yaw)
```

#### 注意事项
- 需要至少 2 条数据点才能拟合直线
- 数据量越多，拟合效果越好
- 使用 PCA（主成分分析）正交距离回归
- 支持 .log、.txt 及无后缀文件
- 左侧显示统计结果，右侧显示轨迹与拟合直线



### 4. ShowLidarRangingError - 激光雷达测距误差分析工具

**功能描述**: 以特定帧为基准，分析雷达在不同距离段的绝对测距精度，自动生成误差分布散点图。

#### 数据准备
- 将多帧点云文件（`.pcd` 格式）放入 `ShowLidarRangingError/logs/` 目录
- 确保点数一致，点云点序对应

#### 配置参数（修改 `main.py`）
```python
# 配置点云文件夹路径
PCD_FOLDER = "./logs"

# 配置距离范围（单位：米）
dist_range=(1.0, 20.0)

# 配置输出文件
output_txt="./out/lidar_error_data.txt"
```

#### 启动命令
```bash
cd ShowLidarRangingError
py main.py
```

#### 结果说明
- 自动生成散点图（显示误差 vs 距离）
- 数据保存到 `out/lidar_error_data.txt`
- 图表保存到 `out/lidar_error_plot.png`

#### 分析逻辑
- 以第 0 帧为基准计算测距长度
- 计算所有帧两两之间的最大欧式距离作为误差
- 筛选满足距离范围且误差 <= 0.041m 的点

#### 附加功能：折线图对比

使用 `compare.py` 可生成距离-误差折线图：

```bash
cd ShowLidarRangingError
py compare.py
```

**compare.py 功能**:
- 读取 `out/` 目录下的 TXT 数据文件
- 按 X 轴（距离）排序
- 每隔指定间隔（默认 0.2m）采样一个点
- 绘制多条折线对比不同数据集
- 自动保存为 `out/connected_lines_plot.png`

#### 注意事项
- 需要至少 2 个 PCD 文件进行误差计算
- 点数不一致会导致对应错误
- 输出目录会自动创建
- 图表会自动显示，关闭后程序结束

### 5. StaticPose - 静态位姿分析工具

**功能描述**: 专项分析机器人在**静止状态**下的定位漂移现象。通过统计 X、Y、RZ 的极值与标准差，评估定位系统的绝对稳定性和抗噪能力。

#### 启动命令
```bash
cd StaticPose
py main.py
```

#### 使用流程
1. 点击【选择文件夹】按钮，选择包含日志文件的目录
2. 程序会自动递归搜索子目录中的所有日志文件（.log、.txt）
3. 在左侧下拉框选择分析的起始时间和结束时间
4. 选择定位类型（type）
5. 点击【开始分析】按钮

#### 分析结果解读

**X/Y 位置分析**:
- **最大值/最小值**: 位置的极端值
- **平均值**: 理想情况下应接近真值
- **波动范围**: 最大值与最小值之差
- **标准差**: 波动程度，越小越优

**RZ 偏航角分析**:
- **最大值/最小值**: 角度的极端值
- **平均值**: 理想情况下应接近真实角度
- **波动范围**: 角度变化范围
- **标准差**: 角度稳定性指标

#### 评估标准
- 标准差（Standard Deviation）越接近 0，说明静态无波动，定位系统越优秀
- 适用于机器人静止时采集的数据
- 数据量越大，统计结果越可靠

#### 日志格式要求
```
2024-01-15 10:30:45,123 ... type = 20 (x y z roll pitch yaw)
```

#### 注意事项
- 适用于静态场景数据，运动轨迹数据分析不准确
- 支持 .log、.txt 及无后缀文件
- 结果显示在右侧滚动文本框中
- 窗口尺寸：850x650，可调整

---

### 6. TrajectoryComparison - 轨迹评估对比工具（Evo-like）

**功能描述**: 仿照 Evo 评估工具，对比两条轨迹的 APE（绝对位姿误差）和 RPE（相对位姿误差），支持逐帧跳转查看，是评估定位算法精度的专业工具。

#### 数据准备
- 将轨迹日志文件（`.log` 或 `.txt`）放入 `TrajectoryComparison/logs/` 目录
- 日志格式要求：
```
2024-01-15 10:30:45,123
Location_state = RealTimeLocation:10 type = 20 (x y z roll pitch yaw)
```

#### 启动命令
```bash
cd TrajectoryComparison
py main.py
```

#### 界面布局
- **左侧面板**：轨迹选择、误差报告、实时误差显示、详细帧信息
- **右侧面板**：轨迹可视化绘图区

#### 主要功能

1. **轨迹选择**
   - Reference (GT)：选择基准轨迹（真值）
   - Estimated：选择待评估轨迹
   - 支持下拉框快速切换

2. **APE 评估（绝对位姿误差）**
   - 评估全局一致性
   - 计算两帧之间的欧式距离
   - 指标：RMSE、Mean、Max、Min、Std

3. **RPE 评估（相对位姿误差）**
   - 评估局部精度
   - Step = 1（相邻帧对比）
   - 将世界坐标位移转换到局部坐标系
   - 指标：RMSE、Mean、Max、Min、Std

4. **逐帧对比**
   - 显示当前帧的位姿偏移
   - 实时显示两条轨迹的位置、状态、类型
   - 状态颜色标识：绿色（正常）、红色（异常）

5. **交互操作**
   - `右箭头`：下一帧
   - `左箭头`：上一帧
   - 鼠标点击轨迹点：自动跳转到最近帧

#### 评估指标解读

**APE (Absolute Pose Error)**:
- **RMSE**: 均方根误差，衡量整体精度
- **Mean**: 平均误差
- **Max/Min**: 极端误差值
- **Std**: 误差标准差，越小说明越稳定

**RPE (Relative Pose Error)**:
- **RMSE**: 相对运动的均方根误差
- **Mean**: 平均相对误差
- **Std**: 局部运动的一致性

#### 注意事项
- 确保两条轨迹的时间戳对齐
- 轨迹长度可以不同，取较短的长度进行对比
- 结果显示在左侧文本框中
- 右侧绘图区显示两条轨迹和当前帧位置
- 支持点击跳转功能（5m 范围内）

---

## ❓ 常见问题与排错 (FAQ)

**Q1: 命令行提示 `'pip' 或 'py' 不是内部或外部命令**`**

* **A**: 安装 Python 时忘记勾选 `Add to PATH`。请重新运行安装包，选择 `Modify` -> `Advanced Options`，勾选 `Add Python to environment variables`。

**Q2: 导入 Open3D 时报错或系统提示缺少 DLL**

* **A**: 某些精简版 Windows 可能缺少 C++ 运行库。请下载并安装 [微软 Visual C++ 可再发行组件包](https://www.google.com/search?q=https://aka.ms/vs/17/release/vc_redist.x64.exe)。

**Q3: 处理海量点云时程序闪退（内存溢出）**

* **A**: `Open3D` 非常吃内存。请在代码中尝试增加点云降采样（Voxel Downsampling）逻辑，或关闭后台高内存占用软件。

---

*内部工具，未经授权请勿外传。*
*最后更新：2026年2月*
